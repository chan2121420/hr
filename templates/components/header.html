<nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom shadow-sm">
    <div class="container-fluid">
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto mt-2 mt-lg-0">
                
                <li class="nav-item dropdown">
                    <a class="nav-link" href="#" id="notificationDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="fas fa-bell"></i>
                        <span class="badge rounded-pill bg-danger d-none" id="notification-count"></span>
                    </a>
                    <div class="dropdown-menu dropdown-menu-end" id="notification-dropdown-menu" aria-labelledby="notificationDropdown">
                        <a class="dropdown-item text-muted" href="#">Loading...</a>
                    </div>
                </li>

                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <img src="/media/avatars/default.png" alt="Avatar" class="rounded-circle" width="30" height="30" id="header-avatar">
                        <span id="header-username">User</span>
                    </a>
                    <div class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                        <a class="dropdown-item" href="#">My Profile</a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="#" onclick="logoutUser()">Logout</a>
                    </div>
                </li>
            </ul>
        </div>
    </div>
</nav>

<script>
    async function logoutUser() {
        try {
            await hrApi.post('accounts/logout/');
        } catch (error) {
            console.error("Logout failed, but proceeding anyway:", error);
        }
        localStorage.removeItem('authToken');
        localStorage.removeItem('userData');
        window.location.href = '/api-auth/login/'; // Redirect to login
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadNotifications();
    });

    async function loadNotifications() {
        const countBadge = document.getElementById('notification-count');
        const dropdown = document.getElementById('notification-dropdown-menu');

        try {
            // Using the new hrApi client
            const notifications = await hrApi.get('notifications/notifications/?is_read=false');
            
            if (notifications.length > 0) {
                countBadge.textContent = notifications.length;
                countBadge.classList.remove('d-none');
                
                dropdown.innerHTML = ''; // Clear loading item
                notifications.slice(0, 5).forEach(n => {
                    dropdown.innerHTML += `<a class="dropdown-item" href="#">
                        <span class="small text-muted">${new Date(n.created_at).toLocaleDateString()}</span><br>
                        ${n.message}
                    </a>`;
                });
                dropdown.innerHTML += '<div class="dropdown-divider"></div>';
                dropdown.innerHTML += '<a class="dropdown-item text-center small" href="#">View all</a>';

            } else {
                countBadge.classList.add('d-none');
                dropdown.innerHTML = '<a class="dropdown-item text-muted" href="#">No new notifications</a>';
            }

        } catch (error) {
            console.error('Failed to load notifications:', error);
            dropdown.innerHTML = '<a class="dropdown-item text-danger" href="#">Could not load</a>';
        }
    }
</script>