{% extends "base.html" %}
{% load static %}

{% block title %}My Leaves{% endblock %}

{% block content %}
<div class="container-fluid p-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h2">My Leave Requests</h1>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#requestLeaveModal">
            <i class="fas fa-plus me-1"></i> Request Leave
        </button>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Type</th>
                            <th>Dates</th>
                            <th>Days</th>
                            <th>Status</th>
                            <th>Reviewer</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="leave-table-body">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="requestLeaveModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">New Leave Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="leaveRequestForm">
                    <div class="mb-3">
                        <label class="form-label">Leave Type</label>
                        <select class="form-select" id="leave_type" required>
                            <option value="">Loading...</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="start_date" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-control" id="end_date" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Reason</label>
                        <textarea class="form-control" id="reason" rows="3" required></textarea>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Submit Request</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        loadLeaveRequests();
        loadLeaveTypes();
    });

    document.getElementById('leaveRequestForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const body = {
            leave_type_id: document.getElementById('leave_type').value,
            start_date: document.getElementById('start_date').value,
            end_date: document.getElementById('end_date').value,
            reason: document.getElementById('reason').value,
        };
        
        try {
            await hrApi.post('leaves/requests/', body);
            bootstrap.Modal.getInstance(document.getElementById('requestLeaveModal')).hide();
            document.getElementById('leaveRequestForm').reset();
            loadLeaveRequests();
            showToast('Leave request submitted successfully.', 'success');
        } catch (error) {
            showToast(`Error: ${error.message}`, 'danger');
        }
    });

    async function loadLeaveRequests() {
        try {
            const requests = await hrApi.get('leaves/requests/');
            const tableBody = document.getElementById('leave-table-body');
            tableBody.innerHTML = ''; 

            if (requests.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No leave requests found.</td></tr>';
                return;
            }

            requests.forEach(req => {
                let statusBadge = getStatusBadge(req.status);
                let row = `
                    <tr>
                        <td><strong>${req.leave_type_name || req.leave_type}</strong></td>
                        <td>${req.start_date} to ${req.end_date}</td>
                        <td>${req.total_leave_days}</td>
                        <td>${statusBadge}</td>
                        <td>${req.reviewed_by || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" 
                                    ${req.status !== 'PENDING' ? 'disabled' : ''} 
                                    onclick="cancelRequest(${req.id}, this)">
                                Cancel
                            </button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        } catch (error) {
            console.error(error);
        }
    }

    async function loadLeaveTypes() {
        try {
            const types = await hrApi.get('leaves/types/');
            const select = document.getElementById('leave_type');
            select.innerHTML = '<option value="">Select a type...</option>';
            types.forEach(type => {
                select.innerHTML += `<option value="${type.id}">${type.name}</option>`;
            });
        } catch (error) {
            console.error(error);
        }
    }

    async function cancelRequest(id, button) {
        if (!confirm('Are you sure you want to cancel this request?')) return;
        
        button.disabled = true;
        try {
            await hrApi.patch(`leaves/requests/${id}/`, { status: 'CANCELLED' });
            showToast('Request cancelled.', 'info');
            loadLeaveRequests();
        } catch (error) {
            showToast(`Error: ${error.message}`, 'danger');
            button.disabled = false;
        }
    }

    function getStatusBadge(status) {
        let badgeClass = 'bg-secondary';
        if (status === 'PENDING') badgeClass = 'bg-warning text-dark';
        if (status === 'APPROVED') badgeClass = 'bg-success';
        if (status === 'REJECTED') badgeClass = 'bg-danger';
        return `<span class="badge ${badgeClass}">${status}</span>`;
    }
</script>
{% endblock %}