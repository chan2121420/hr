{%load static%}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Profile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #4F46E5;
            --secondary: #7C3AED;
        }
        
        body {
            background: #F3F4F6;
            font-family: 'Inter', sans-serif;
        }
        
        .profile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 3rem 0;
            position: relative;
            overflow: hidden;
        }
        
        .profile-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="rgba(255,255,255,0.1)" d="M0,96L48,112C96,128,192,160,288,160C384,160,480,128,576,122.7C672,117,768,139,864,138.7C960,139,1056,117,1152,106.7C1248,96,1344,96,1392,96L1440,96L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>') no-repeat bottom;
            background-size: cover;
        }
        
        .profile-avatar {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 5px solid white;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            object-fit: cover;
        }
        
        .info-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }
        
        .info-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }
        
        .info-card-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #E5E7EB;
            margin-bottom: 1.5rem;
        }
        
        .info-card-icon {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #F3F4F6;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            color: #6B7280;
            font-weight: 500;
        }
        
        .info-value {
            color: #111827;
            font-weight: 600;
            text-align: right;
        }
        
        .metric-badge {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .metric-badge h3 {
            margin: 0;
            font-size: 2rem;
        }
        
        .metric-badge p {
            margin: 0.5rem 0 0;
            opacity: 0.9;
            font-size: 0.9rem;
        }
        
        .action-button {
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            margin: 0.25rem;
        }
        
        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        
        .timeline-item {
            position: relative;
            padding-left: 40px;
            padding-bottom: 2rem;
        }
        
        .timeline-marker {
            position: absolute;
            left: 0;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary);
            border: 4px solid white;
            box-shadow: 0 0 0 4px #E5E7EB;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 7px;
            top: 20px;
            bottom: -10px;
            width: 2px;
            background: #E5E7EB;
        }
        
        .timeline-item:last-child::before {
            display: none;
        }
        
        .document-card {
            background: white;
            border: 2px solid #E5E7EB;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.2s ease;
        }
        
        .document-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.1);
        }
        
        .tab-modern .nav-link {
            color: #6B7280;
            font-weight: 600;
            border: none;
            padding: 1rem 1.5rem;
            transition: all 0.3s ease;
        }
        
        .tab-modern .nav-link:hover {
            color: var(--primary);
        }
        
        .tab-modern .nav-link.active {
            color: var(--primary);
            background: none;
            border-bottom: 3px solid var(--primary);
        }
        
        .badge-custom {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
        }
        
        .contact-card {
            background: #F9FAFB;
            border-left: 4px solid var(--primary);
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="profile-header">
        <div class="container position-relative">
            <a href="/employees/" class="btn btn-light mb-3">
                <i class="fas fa-arrow-left me-2"></i>Back to List
            </a>
            <div class="row align-items-end">
                <div class="col-md-8">
                    <div class="d-flex align-items-center gap-4">
                        <img id="employee-avatar" src="" class="profile-avatar" alt="Profile">
                        <div>
                            <h1 class="mb-2" id="employee-name">Loading...</h1>
                            <p class="mb-1 fs-5" id="employee-designation"></p>
                            <p class="mb-0 opacity-75" id="employee-department"></p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <span class="badge-custom" id="employee-status" style="background: rgba(255,255,255,0.2);">Active</span>
                </div>
            </div>
        </div>
    </div>

    <div class="container py-4">
        <div class="row">
            <!-- Left Column -->
            <div class="col-lg-8">
                <!-- Tabs -->
                <ul class="nav nav-tabs tab-modern mb-3" id="profileTabs">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#overview">
                            <i class="fas fa-info-circle me-2"></i>Overview
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#documents">
                            <i class="fas fa-file me-2"></i>Documents
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#timeline">
                            <i class="fas fa-history me-2"></i>Timeline
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#team">
                            <i class="fas fa-users me-2"></i>Team
                        </a>
                    </li>
                </ul>

                <div class="tab-content">
                    <!-- Overview Tab -->
                    <div class="tab-pane fade show active" id="overview">
                        <!-- Personal Information -->
                        <div class="info-card">
                            <div class="info-card-header">
                                <div class="info-card-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                                    <i class="fas fa-user"></i>
                                </div>
                                <h5 class="mb-0">Personal Information</h5>
                            </div>
                            <div id="personal-info">
                                <div class="text-center py-3">
                                    <div class="spinner-border text-primary" role="status"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Employment Details -->
                        <div class="info-card">
                            <div class="info-card-header">
                                <div class="info-card-icon" style="background: linear-gradient(135deg, #10B981, #059669);">
                                    <i class="fas fa-briefcase"></i>
                                </div>
                                <h5 class="mb-0">Employment Details</h5>
                            </div>
                            <div id="employment-info"></div>
                        </div>

                        <!-- Bank Details -->
                        <div class="info-card">
                            <div class="info-card-header">
                                <div class="info-card-icon" style="background: linear-gradient(135deg, #F59E0B, #D97706);">
                                    <i class="fas fa-university"></i>
                                </div>
                                <h5 class="mb-0">Bank Details</h5>
                            </div>
                            <div id="bank-info"></div>
                        </div>

                        <!-- Emergency Contacts -->
                        <div class="info-card">
                            <div class="info-card-header">
                                <div class="info-card-icon" style="background: linear-gradient(135deg, #EF4444, #DC2626);">
                                    <i class="fas fa-phone-alt"></i>
                                </div>
                                <h5 class="mb-0">Emergency Contacts</h5>
                            </div>
                            <div id="emergency-contacts"></div>
                        </div>
                    </div>

                    <!-- Documents Tab -->
                    <div class="tab-pane fade" id="documents">
                        <div class="info-card">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">Employee Documents</h5>
                                <button class="btn btn-primary btn-sm" onclick="uploadDocument()">
                                    <i class="fas fa-upload me-2"></i>Upload Document
                                </button>
                            </div>
                            <div id="documents-list"></div>
                        </div>
                    </div>

                    <!-- Timeline Tab -->
                    <div class="tab-pane fade" id="timeline">
                        <div class="info-card">
                            <h5 class="mb-4">Employment Timeline</h5>
                            <div id="timeline-content"></div>
                        </div>
                    </div>

                    <!-- Team Tab -->
                    <div class="tab-pane fade" id="team">
                        <div class="info-card">
                            <h5 class="mb-4">Team & Reporting</h5>
                            <div id="team-content"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="col-lg-4">
                <!-- Quick Actions -->
                <div class="info-card">
                    <h6 class="mb-3">Quick Actions</h6>
                    <div class="d-grid gap-2">
                        <button class="action-button btn btn-primary" onclick="editEmployee()">
                            <i class="fas fa-edit me-2"></i>Edit Profile
                        </button>
                        <button class="action-button btn btn-success" onclick="viewPayroll()">
                            <i class="fas fa-dollar-sign me-2"></i>View Payroll
                        </button>
                        <button class="action-button btn btn-info" onclick="viewLeaves()">
                            <i class="fas fa-plane me-2"></i>Leave Records
                        </button>
                        <button class="action-button btn btn-warning" onclick="viewAttendance()">
                            <i class="fas fa-clock me-2"></i>Attendance
                        </button>
                        <button class="action-button btn btn-secondary" onclick="generateReport()">
                            <i class="fas fa-file-pdf me-2"></i>Generate Report
                        </button>
                    </div>
                </div>

                <!-- Key Metrics -->
                <div class="metric-badge">
                    <i class="fas fa-calendar-alt fa-2x mb-2"></i>
                    <h3 id="tenure-display">0</h3>
                    <p>Years of Service</p>
                </div>

                <div class="metric-badge" style="background: linear-gradient(135deg, #10B981, #059669);">
                    <i class="fas fa-star fa-2x mb-2"></i>
                    <h3 id="rating-display">0.0</h3>
                    <p>Performance Rating</p>
                </div>

                <!-- Reporting Chain -->
                <div class="info-card">
                    <h6 class="mb-3">Reporting Chain</h6>
                    <div id="reporting-chain"></div>
                </div>

                <!-- Dependents -->
                <div class="info-card">
                    <h6 class="mb-3">Dependents</h6>
                    <div id="dependents-list"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = '/api/employees';
        const employeeId = window.location.pathname.split('/')[2];

        document.addEventListener('DOMContentLoaded', () => {
            loadEmployeeProfile();
        });

        async function loadEmployeeProfile() {
            try {
                const response = await fetch(`${API_URL}/employees/${employeeId}/`, {
                    headers: { 'Authorization': `Token ${localStorage.getItem('authToken')}` }
                });
                const employee = await response.json();
                
                displayEmployeeHeader(employee);
                displayPersonalInfo(employee);
                displayEmploymentInfo(employee);
                displayBankDetails(employee);
                displayEmergencyContacts(employee);
                displayDocuments(employee);
                displayTimeline(employee);
                displayTeam(employee);
                displayDependents(employee);
                displayReportingChain(employee);
                
            } catch (error) {
                console.error('Failed to load employee:', error);
                alert('Failed to load employee profile');
            }
        }

        function displayEmployeeHeader(emp) {
            const avatarUrl = emp.user?.profile?.avatar || 
                `https://ui-avatars.com/api/?name=${emp.user?.first_name}+${emp.user?.last_name}&size=150&background=667eea&color=fff`;
            
            document.getElementById('employee-avatar').src = avatarUrl;
            document.getElementById('employee-name').textContent = 
                `${emp.user?.first_name || ''} ${emp.user?.last_name || ''}`;
            document.getElementById('employee-designation').textContent = 
                emp.designation_title || 'No designation';
            document.getElementById('employee-department').textContent = 
                emp.department_name || 'No department';
            document.getElementById('employee-status').textContent = emp.status;
            document.getElementById('tenure-display').textContent = emp.tenure_years || 0;
            document.getElementById('rating-display').textContent = emp.performance_rating || 'N/A';
        }

        function displayPersonalInfo(emp) {
            const html = `
                <div class="info-row">
                    <span class="info-label">Employee ID</span>
                    <span class="info-value">${emp.employee_id}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Email</span>
                    <span class="info-value">${emp.work_email || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Phone</span>
                    <span class="info-value">${emp.work_phone || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">National ID</span>
                    <span class="info-value">${emp.national_id || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Tax Number</span>
                    <span class="info-value">${emp.tax_number || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">NSSA Number</span>
                    <span class="info-value">${emp.nssa_number || 'N/A'}</span>
                </div>
            `;
            document.getElementById('personal-info').innerHTML = html;
        }

        function displayEmploymentInfo(emp) {
            const html = `
                <div class="info-row">
                    <span class="info-label">Join Date</span>
                    <span class="info-value">${new Date(emp.join_date).toLocaleDateString()}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Employment Type</span>
                    <span class="info-value">${emp.employment_type}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Work Location</span>
                    <span class="info-value">${emp.work_location || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Manager</span>
                    <span class="info-value">${emp.manager_name || 'N/A'}</span>
                </div>
                ${emp.contract_end_date ? `
                <div class="info-row">
                    <span class="info-label">Contract End Date</span>
                    <span class="info-value">${new Date(emp.contract_end_date).toLocaleDateString()}</span>
                </div>` : ''}
                ${emp.next_review_date ? `
                <div class="info-row">
                    <span class="info-label">Next Review</span>
                    <span class="info-value">${new Date(emp.next_review_date).toLocaleDateString()}</span>
                </div>` : ''}
            `;
            document.getElementById('employment-info').innerHTML = html;
        }

        function displayBankDetails(emp) {
            if (!emp.bank_details) {
                document.getElementById('bank-info').innerHTML = '<p class="text-muted">No bank details on file</p>';
                return;
            }
            
            const bank = emp.bank_details;
            const html = `
                <div class="info-row">
                    <span class="info-label">Bank Name</span>
                    <span class="info-value">${bank.bank_name}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Account Number</span>
                    <span class="info-value">${bank.account_number}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Account Type</span>
                    <span class="info-value">${bank.account_type}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Branch</span>
                    <span class="info-value">${bank.branch_name || 'N/A'}</span>
                </div>
                ${bank.is_verified ? '<div class="alert alert-success mt-3 mb-0"><i class="fas fa-check-circle me-2"></i>Verified</div>' : ''}
            `;
            document.getElementById('bank-info').innerHTML = html;
        }

        function displayEmergencyContacts(emp) {
            if (!emp.emergency_contacts || emp.emergency_contacts.length === 0) {
                document.getElementById('emergency-contacts').innerHTML = '<p class="text-muted">No emergency contacts</p>';
                return;
            }
            
            const html = emp.emergency_contacts.map(contact => `
                <div class="contact-card">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="mb-0">${contact.name}</h6>
                        ${contact.is_primary ? '<span class="badge bg-primary">Primary</span>' : ''}
                    </div>
                    <p class="mb-1"><i class="fas fa-heart me-2"></i>${contact.relationship}</p>
                    <p class="mb-1"><i class="fas fa-phone me-2"></i>${contact.phone_number}</p>
                    ${contact.email ? `<p class="mb-0"><i class="fas fa-envelope me-2"></i>${contact.email}</p>` : ''}
                </div>
            `).join('');
            document.getElementById('emergency-contacts').innerHTML = html;
        }

        function displayDocuments(emp) {
            if (!emp.documents || emp.documents.length === 0) {
                document.getElementById('documents-list').innerHTML = '<p class="text-muted">No documents uploaded</p>';
                return;
            }
            
            const html = emp.documents.map(doc => `
                <div class="document-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${doc.title}</h6>
                            <small class="text-muted">${doc.document_type} • ${doc.file_size_mb} MB</small>
                        </div>
                        <div>
                            <a href="${doc.document}" class="btn btn-sm btn-primary" download>
                                <i class="fas fa-download"></i>
                            </a>
                        </div>
                    </div>
                    ${doc.is_verified ? '<span class="badge bg-success mt-2">Verified</span>' : ''}
                    ${doc.is_expiring_soon ? '<span class="badge bg-warning mt-2">Expiring Soon</span>' : ''}
                </div>
            `).join('');
            document.getElementById('documents-list').innerHTML = html;
        }

        function displayTimeline(emp) {
            const events = [
                { date: emp.join_date, label: 'Joined Company', icon: 'user-plus', color: '#10B981' },
                emp.confirmation_date && { date: emp.confirmation_date, label: 'Confirmed', icon: 'check-circle', color: '#3B82F6' },
                emp.last_promotion_date && { date: emp.last_promotion_date, label: 'Last Promotion', icon: 'arrow-up', color: '#F59E0B' },
            ].filter(Boolean);
            
            const html = events.map((event, idx) => `
                <div class="timeline-item">
                    <div class="timeline-marker" style="background: ${event.color};"></div>
                    <div>
                        <h6 class="mb-1">${event.label}</h6>
                        <p class="mb-0 text-muted">${new Date(event.date).toLocaleDateString()}</p>
                    </div>
                </div>
            `).join('');
            document.getElementById('timeline-content').innerHTML = html || '<p class="text-muted">No timeline events</p>';
        }

        function displayTeam(emp) {
            // This would typically fetch team data
            document.getElementById('team-content').innerHTML = '<p class="text-muted">Team information loading...</p>';
        }

        function displayDependents(emp) {
            if (!emp.dependents || emp.dependents.length === 0) {
                document.getElementById('dependents-list').innerHTML = '<p class="text-muted mb-0">No dependents</p>';
                return;
            }
            
            const html = emp.dependents.map(dep => `
                <div class="contact-card mb-2">
                    <h6 class="mb-1">${dep.name}</h6>
                    <small class="text-muted">${dep.relationship} • Age ${dep.age}</small>
                </div>
            `).join('');
            document.getElementById('dependents-list').innerHTML = html;
        }

        function displayReportingChain(emp) {
            if (!emp.reporting_chain || emp.reporting_chain.length === 0) {
                document.getElementById('reporting-chain').innerHTML = '<p class="text-muted mb-0">No reporting chain</p>';
                return;
            }
            
            const html = emp.reporting_chain.map((mgr, idx) => `
                <div class="d-flex align-items-center mb-2">
                    <div class="me-3">
                        <div style="width: 10px; height: 10px; background: var(--primary); border-radius: 50%;"></div>
                    </div>
                    <div>
                        <strong>${mgr.name}</strong>
                        <br><small class="text-muted">${mgr.designation || ''}</small>
                    </div>
                </div>
            `).join('');
            document.getElementById('reporting-chain').innerHTML = html;
        }

        // Action functions
        function editEmployee() {
            window.location.href = `/employees/${employeeId}/edit/`;
        }

        function viewPayroll() {
            window.location.href = `/payroll/employee/${employeeId}/`;
        }

        function viewLeaves() {
            window.location.href = `/leaves/employee/${employeeId}/`;
        }

        function viewAttendance() {
            window.location.href = `/attendance/employee/${employeeId}/`;
        }

        function generateReport() {
            alert('Report generation coming soon!');
        }

        function uploadDocument() {
            alert('Document upload coming soon!');
        }
    </script>
</body>
</html>