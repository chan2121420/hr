{% extends "base.html" %}
{% load static %}

{% block title %}Recruitment{% endblock %}

{% block content %}
<div class="container-fluid p-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h2">Recruitment Portal</h1>
        {% if user.is_staff %}
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addJobModal">
            <i class="fas fa-plus me-1"></i> Post New Job
        </button>
        {% endif %}
    </div>

    <div class="row" id="job-postings-list">
        <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="text-muted mt-2">Loading job postings...</p>
        </div>
    </div>
</div>

<div class="modal fade" id="addJobModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Post New Job</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addJobForm">
                    <div class="mb-3">
                        <label class="form-label">Job Title</label>
                        <input type="text" class="form-control" id="jobTitle" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Department</label>
                            <input type="text" class="form-control" id="jobDepartment" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Closing Date</label>
                            <input type="date" class="form-control" id="jobClosingDate" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="jobDescription" rows="5" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Requirements</label>
                        <textarea class="form-control" id="jobRequirements" rows="5" required></textarea>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Publish Job</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="jobDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="jobDetailsModalLabel">Job Title</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6 class="text-muted mb-3">Candidate Pipeline</h6>
                <div class="row g-3">
                    <div class="col"><div class="card bg-light h-100"><div class="card-body"><h6 class="text-uppercase small fw-bold">Applied</h6><div id="stage-APPLIED"></div></div></div></div>
                    <div class="col"><div class="card bg-light h-100"><div class="card-body"><h6 class="text-uppercase small fw-bold">Screening</h6><div id="stage-SCREENING"></div></div></div></div>
                    <div class="col"><div class="card bg-light h-100"><div class="card-body"><h6 class="text-uppercase small fw-bold">Interview</h6><div id="stage-INTERVIEW"></div></div></div></div>
                    <div class="col"><div class="card bg-light h-100"><div class="card-body"><h6 class="text-uppercase small fw-bold">Offer</h6><div id="stage-OFFER"></div></div></div></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        loadJobs();
    });

    // Handle Add Job Form
    const addJobForm = document.getElementById('addJobForm');
    if (addJobForm) {
        addJobForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                title: document.getElementById('jobTitle').value,
                department: document.getElementById('jobDepartment').value,
                closing_date: document.getElementById('jobClosingDate').value,
                description: document.getElementById('jobDescription').value,
                requirements: document.getElementById('jobRequirements').value,
                status: 'OPEN'
            };
            try {
                await hrApi.post('recruitment/jobs/', data);
                bootstrap.Modal.getInstance(document.getElementById('addJobModal')).hide();
                addJobForm.reset();
                loadJobs();
                showToast('Job posted successfully', 'success');
            } catch (error) {
                showToast(error.message, 'danger');
            }
        });
    }

    async function loadJobs() {
        try {
            const jobs = await hrApi.get('recruitment/jobs/');
            const list = document.getElementById('job-postings-list');
            list.innerHTML = ''; 

            if (jobs.length === 0) {
                list.innerHTML = '<div class="col-12 text-center text-muted">No open job postings.</div>';
                return;
            }

            jobs.forEach(job => {
                let item = `
                    <div class="col-md-6 mb-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <h5 class="card-title text-primary">${job.title}</h5>
                                    <span class="badge bg-primary rounded-pill">${job.application_count || 0} Applicants</span>
                                </div>
                                <h6 class="card-subtitle mb-3 text-muted">${job.department}</h6>
                                <p class="card-text small text-secondary">${job.description ? job.description.substring(0, 120) + '...' : ''}</p>
                                <div class="mt-auto pt-2">
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewJobPipeline(${job.id}, '${job.title}')">
                                        <i class="fas fa-columns me-1"></i> Manage Pipeline
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                list.innerHTML += item;
            });
        } catch (e) { console.error(e); }
    }

    async function viewJobPipeline(jobId, jobTitle) {
        document.getElementById('jobDetailsModalLabel').textContent = jobTitle;
        const modal = new bootstrap.Modal(document.getElementById('jobDetailsModal'));
        
        ['APPLIED', 'SCREENING', 'INTERVIEW', 'OFFER'].forEach(id => document.getElementById(`stage-${id}`).innerHTML = '');
        
        try {
            const applications = await hrApi.get(`recruitment/jobs/${jobId}/applications/`);
            
            applications.forEach(app => {
                const container = document.getElementById(`stage-${app.stage}`);
                if (container) {
                    container.innerHTML += `
                        <div class="card shadow-sm my-2 border-0 border-start border-4 border-primary">
                            <div class="card-body p-2">
                                <div class="fw-bold">${app.candidate_name || 'Candidate'}</div>
                                <div class="small text-muted">${app.email || ''}</div>
                                <div class="small mt-1"><span class="badge bg-light text-dark">${app.rating ? app.rating + '/5' : '-'}</span></div>
                            </div>
                        </div>
                    `;
                }
            });
            modal.show();
        } catch (e) { showToast('Failed to load pipeline', 'danger'); }
    }
</script>
{% endblock %}