{% extends "base.html" %}
{% load static %}

{% block title %}Dashboard - HRMaster{% endblock %}

{% block content %}
<h1 class="h2 mb-4">Dashboard</h1>

<div class="row" id="summary-cards">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-start-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row g-0 align-items-center">
                    <div class="col">
                        <div class="text-xs fw-bold text-primary text-uppercase mb-1">Active Employees</div>
                        <div class="h5 mb-0 fw-bold text-gray-800" id="total-employees">...</div>
                    </div>
                    <div class="col-auto"><i class="fas fa-users fa-2x text-gray-300"></i></div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-start-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row g-0 align-items-center">
                    <div class="col">
                        <div class="text-xs fw-bold text-warning text-uppercase mb-1">Pending Leaves</div>
                        <div class="h5 mb-0 fw-bold text-gray-800" id="pending-leaves">...</div>
                    </div>
                    <div class="col-auto"><i class="fas fa-calendar-minus fa-2x text-gray-300"></i></div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-start-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row g-0 align-items-center">
                    <div class="col">
                        <div class="text-xs fw-bold text-success text-uppercase mb-1">New Hires (30 Days)</div>
                        <div class="h5 mb-0 fw-bold text-gray-800" id="recent-hires">...</div>
                    </div>
                    <div class="col-auto"><i class="fas fa-user-plus fa-2x text-gray-300"></i></div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-start-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row g-0 align-items-center">
                    <div class="col">
                        <div class="text-xs fw-bold text-info text-uppercase mb-1">Upcoming Reviews</div>
                        <div class="h5 mb-0 fw-bold text-gray-800" id="upcoming-reviews">...</div>
                    </div>
                    <div class="col-auto"><i class="fas fa-clipboard-list fa-2x text-gray-300"></i></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-xl-8 col-lg-7">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 fw-bold text-primary">Headcount by Department</h6>
            </div>
            <div class="card-body">
                <div class="chart-pie pt-4" style="height: 300px;">
                    <canvas id="headcountDeptChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        loadDashboardData();
    });

    async function loadDashboardData() {
        try {
            // Fetch summary data
            const summaryData = await hrApi.get('analytics/summary/');
            document.getElementById('total-employees').textContent = summaryData.total_employees;
            document.getElementById('pending-leaves').textContent = summaryData.pending_leaves;
            document.getElementById('recent-hires').textContent = summaryData.recent_hires;
            document.getElementById('upcoming-reviews').textContent = summaryData.upcoming_reviews;

            // Fetch headcount data
            const headcountData = await hrApi.get('analytics/headcount/');
            
            // Render Pie Chart
            const ctx = document.getElementById('headcountDeptChart');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: headcountData.by_department.map(d => d.key),
                    datasets: [{
                        data: headcountData.by_department.map(d => d.value),
                        backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796'],
                    }],
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });

        } catch (error) {
            console.error('Failed to load dashboard data:', error);
        }
    }
</script>
{% endblock %}