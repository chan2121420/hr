{% extends "base.html" %}
{% load static %}

{% block title %}Dashboard - HRMaster{% endblock %}

{% block content %}
<h1 class="h2 mb-4">Dashboard</h1>

<div class="row" id="summary-cards">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-start-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row g-0 align-items-center">
                    <div class="col">
                        <div class="text-xs fw-bold text-primary text-uppercase mb-1">
                            Active Employees</div>
                        <div class="h5 mb-0 fw-bold text-gray-800" id="total-employees">...</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-users fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

<div class="row">
    <div class="col-xl-8 col-lg-7">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 fw-bold text-primary">Headcount by Department</h6>
            </div>
            <div class="card-body">
                <div class="chart-pie pt-4" style="height: 300px;">
                    <canvas id="headcountDeptChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        loadDashboardData();
    });

    async function loadDashboardData() {
        const token = localStorage.getItem('authToken');
        const headers = {
            'Authorization': `Token ${token}`,
            'Content-Type': 'application/json'
        };

        try {
            // Fetch summary data
            const summaryResponse = await fetch('/api/analytics/summary/', { headers });
            const summaryData = await summaryResponse.json();
            document.getElementById('total-employees').textContent = summaryData.total_employees;
            // ... populate other cards

            // Fetch headcount data
            const headcountResponse = await fetch('/api/analytics/headcount/', { headers });
            const headcountData = await headcountResponse.json();
            
            // Render Pie Chart
            new Chart(document.getElementById('headcountDeptChart'), {
                type: 'doughnut',
                data: {
                    labels: headcountData.by_department.map(d => d.key),
                    datasets: [{
                        data: headcountData.by_department.map(d => d.value),
                        backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'],
                    }],
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });

        } catch (error) {
            console.error('Failed to load dashboard data:', error);
        }
    }
</script>
{% endblock %}